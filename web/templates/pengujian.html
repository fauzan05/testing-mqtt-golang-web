<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CORE - Pengujian</title>
    <script src="auth-check.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
    <link href="sidebar.css" rel="stylesheet">
    <link href="styles.css" rel="stylesheet">
    <style>
        .monitor-card {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 20px;
            border-radius: 12px;
            text-align: center;
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
        }
        .monitor-label {
            font-size: 14px;
            opacity: 0.9;
            margin-bottom: 8px;
        }
        .monitor-value {
            font-size: 32px;
            font-weight: bold;
            margin-bottom: 4px;
        }
        .monitor-unit {
            font-size: 16px;
            opacity: 0.8;
        }
        .inject-btn {
            background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
            color: white;
            padding: 16px 48px;
            border-radius: 12px;
            border: none;
            font-size: 18px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            box-shadow: 0 4px 12px rgba(0,0,0,0.2);
        }
        .inject-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 16px rgba(0,0,0,0.3);
        }
        .inject-btn:active {
            transform: translateY(0);
        }
        .inject-btn.injecting {
            background: linear-gradient(135deg, #43e97b 0%, #38f9d7 100%);
            cursor: not-allowed;
        }
        .status-indicator {
            display: inline-block;
            width: 12px;
            height: 12px;
            border-radius: 50%;
            margin-right: 8px;
        }
        .status-indicator.active {
            background-color: #4ade80;
            box-shadow: 0 0 8px #4ade80;
        }
        .status-indicator.inactive {
            background-color: #f87171;
        }
        
        @keyframes pulse {
            0%, 100% {
                transform: scale(1);
                box-shadow: 0 4px 12px rgba(0,0,0,0.1);
            }
            50% {
                transform: scale(1.05);
                box-shadow: 0 8px 24px rgba(0,0,0,0.3);
            }
        }
        
        @keyframes blink {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }
    </style>
</head>
<body>
    <div class="app">
        <div id="sidebar-root"></div>
        <script src="sidebar.js"></script>
        <main class="main" style="margin-left:220px;">
            <div class="content-card">
                <h2 style="color:#18a0d6;margin-bottom:24px">Pengujian Injeksi Arus 200mA</h2>
                
                <!-- Form Section -->
                <div style="display:grid;grid-template-columns:1fr 1fr 1fr;gap:20px;margin-bottom:24px;padding:20px;background:#f9fafb;border-radius:12px;">
                    <div>
                        <label style="display:block;font-weight:600;color:#374151;margin-bottom:8px;">Pilih Nama Baju</label>
                        <select id="namaSelect" style="width:100%;padding:10px;border:2px solid #d1d5db;border-radius:8px;font-size:14px;">
                            <option value="">-- Pilih Nama Baju --</option>
                        </select>
                    </div>
                    <div>
                        <label style="display:block;font-weight:600;color:#374151;margin-bottom:8px;">Pilih Mode</label>
                        <select id="testMode" onchange="updateModeDisplay()" style="width:100%;padding:10px;border:2px solid #d1d5db;border-radius:8px;font-size:14px;">
                            <option value="quick">Quick Test - Manual Control</option>
                            <option value="special">Special Conduct Suit Test - Auto 200mA</option>
                        </select>
                    </div>
                    <div>
                        <label style="display:block;font-weight:600;color:#374151;margin-bottom:8px;">Pilih Titik Pengukuran</label>
                        <select id="measurementPoint" style="width:100%;padding:10px;border:2px solid #d1d5db;border-radius:8px;font-size:14px;">
                            <option value="">-- Pilih R1-R8 --</option>
                            <option value="R1">R1 - Sarung tangan & tali celana</option>
                            <option value="R2">R2 - Tali celana & tudung</option>
                            <option value="R3">R3 - Tali celana & tudung</option>
                            <option value="R4">R4 - Sarung tangan & tali celana</option>
                            <option value="R5">R5 - Kaos kaki & tali celana</option>
                            <option value="R6">R6 - Kaos kaki & tali celana</option>
                            <option value="R7">R7 - Tali bonding & baju konduktif</option>
                            <option value="R8">R8 - Tali bonding & baju konduktif</option>
                        </select>
                    </div>
                </div>
                
                <!-- Amplitude Control (Only for Quick Mode) -->
                <div id="amplitudeControl" style="display:none;background:white;padding:12px 16px;border-radius:8px;margin-bottom:16px;box-shadow:0 1px 3px rgba(0,0,0,0.1);transition:all 0.3s ease;max-height:0;overflow:hidden;opacity:0;">
                    <div style="display:flex;align-items:center;justify-content:center;gap:10px;">
                        <button type="button" onclick="changeAmplitude(-1)" style="width:36px;height:36px;border-radius:8px;border:none;font-size:18px;font-weight:bold;color:white;background:#6c757d;cursor:pointer;transition:all 0.2s;">-</button>
                        <input type="number" id="amplitudeInput" min="0" max="100" step="1" value="0" onchange="updateAmplitude(this.value)" style="width:60px;text-align:center;padding:8px;border-radius:6px;border:2px solid #d1d5db;font-size:16px;font-weight:600;">
                        <span style="font-size:14px;color:#6b7280;font-weight:500;">%</span>
                        <button type="button" onclick="changeAmplitude(1)" style="width:36px;height:36px;border-radius:8px;border:none;font-size:18px;font-weight:bold;color:white;background:#007bff;cursor:pointer;transition:all 0.2s;">+</button>
                        <input type="range" id="amplitudeSlider" min="0" max="100" step="1" value="0" oninput="updateAmplitudeFromSlider(this.value)" style="flex:1;height:6px;border-radius:3px;margin-left:12px;">
                    </div>
                </div>
                
                <!-- Info Baju -->
                <div id="infoSection" style="display:none;margin-bottom:24px;padding:16px;background:#e0f2fe;border-left:4px solid #0284c7;border-radius:8px;">
                    <div style="display:grid;grid-template-columns:repeat(3,1fr);gap:16px;font-size:14px;">
                        <div><strong>Nama:</strong> <span id="infoNama">-</span></div>
                        <div><strong>Kode:</strong> <span id="infoKode">-</span></div>
                        <div><strong>UPT:</strong> <span id="infoUpt">-</span></div>
                    </div>
                </div>
                
                <!-- Connection Status Dashboard -->
                <div style="display:grid;grid-template-columns:repeat(2, 1fr);gap:12px;margin-bottom:24px;">
                    <!-- WebSocket Status -->
                    <div style="padding:12px 16px;background:#f3f4f6;border-radius:8px;display:flex;align-items:center;gap:8px;">
                        <span class="status-indicator inactive" id="statusIndicator"></span>
                        <span style="font-weight:600;color:#374151;" id="statusText">Server: Checking...</span>
                    </div>
                    
                    <!-- ESP32 Device Status -->
                    <div style="padding:12px 16px;background:#dbeafe;border-radius:8px;display:flex;align-items:center;gap:8px;">
                        <span class="status-indicator inactive" id="deviceIndicator"></span>
                        <span style="font-weight:600;color:#1e40af;" id="deviceText">ESP32: Waiting...</span>
                    </div>
                </div>
                <div style="display:grid;grid-template-columns:repeat(3, 1fr);gap:20px;margin-bottom:32px;">
                    <div class="monitor-card" style="background:linear-gradient(135deg, #667eea 0%, #764ba2 100%);">
                        <div class="monitor-label">Tegangan</div>
                        <div class="monitor-value" id="voltageValue">0.00</div>
                        <div class="monitor-unit">Volt</div>
                    </div>
                    <div class="monitor-card" style="background:linear-gradient(135deg, #f093fb 0%, #f5576c 100%);">
                        <div class="monitor-label">Arus</div>
                        <div class="monitor-value" id="currentValue">0.00</div>
                        <div class="monitor-unit">mA</div>
                    </div>
                    <div class="monitor-card" style="background:linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);">
                        <div class="monitor-label">Hambatan</div>
                        <div class="monitor-value" id="resistanceValue">0.00</div>
                        <div class="monitor-unit">Ω</div>
                    </div>
                </div>
                
                <div style="text-align:center;margin-bottom:24px;display:flex;gap:12px;justify-content:center;flex-wrap:wrap;">
                    <button class="inject-btn" id="injectBtn" style="padding:12px 32px;">
                        <span id="btnText">⚡ Inject 200mA</span>
                    </button>
                    <button class="inject-btn" id="recordBtn" style="padding:12px 32px;background:linear-gradient(135deg, #10b981 0%, #059669 100%);display:none;">
                        <span>📊 Record (Start Timer)</span>
                    </button>
                    <button class="inject-btn" id="stopBtn" style="padding:12px 32px;background:linear-gradient(135deg, #ef4444 0%, #dc2626 100%);display:none;">
                        <span>⏹️ Stop</span>
                    </button>
                </div>
                
                <!-- Timer Display -->
                <div id="timerDisplay" style="text-align:center;margin-bottom:24px;display:none;">
                    <div style="background:#e0e7ff;padding:16px;border-radius:12px;display:inline-block;">
                        <div style="font-size:14px;color:#4338ca;font-weight:600;margin-bottom:4px;">Waktu Tersisa</div>
                        <div style="font-size:36px;font-weight:bold;color:#4f46e5;font-family:monospace;" id="timerValue">00:00</div>
                    </div>
                </div>
                
                <div style="background:#fef3c7;border-left:4px solid #f59e0b;padding:16px;border-radius:8px;margin-bottom:24px;">
                    <div style="font-weight:600;color:#92400e;margin-bottom:4px;">ℹ️ Informasi</div>
                    <div style="color:#78350f;font-size:14px;">
                        Pilih nama baju dan titik pengukuran (R1-R8), kemudian klik "Inject 200mA". Sistem akan memonitor selama 2 detik (mode testing) dan menyimpan hasil otomatis.
                    </div>
                </div>
                
                <!-- Hasil Pengujian -->
                <div style="background:white;border-radius:12px;overflow:hidden;">
                    <div style="background:#18a0d6;color:white;padding:12px 16px;font-weight:600;">
                        📊 Hasil Pengujian
                    </div>
                    <div style="overflow-x:auto;">
                        <table style="width:100%;border-collapse:collapse;">
                            <thead style="background:#f3f4f6;">
                                <tr>
                                    <th style="padding:12px;text-align:left;border-bottom:2px solid #e5e7eb;">Titik Pengujian</th>
                                    <th style="padding:12px;text-align:center;border-bottom:2px solid #e5e7eb;">Hasil (Ohm)</th>
                                    <th style="padding:12px;text-align:center;border-bottom:2px solid #e5e7eb;">Status</th>
                                </tr>
                            </thead>
                            <tbody id="resultsTable">
                                <tr><td colspan="3" style="padding:20px;text-align:center;color:#9ca3af;">Belum ada data pengujian</td></tr>
                            </tbody>
                        </table>
                    </div>
                </div>
                
                <div style="margin-top:24px;text-align:center;display:flex;gap:12px;justify-content:center;">
                    <button id="saveAllBtn" style="background:#10b981;color:white;padding:14px 40px;border-radius:8px;border:none;font-weight:600;cursor:pointer;display:none;font-size:16px;box-shadow:0 4px 12px rgba(16,185,129,0.3);">
                        ✅ Selesai - Simpan Data
                    </button>
                </div>
            </div>
        </main>
    </div>
    <script>
        let ws;
        let isInjecting = false;
        let isRecording = false;
        let intervalId = null;
        let timerInterval = null;
        let remainingTime = 15; // Default 15 seconds
        let suitList = [];
        let selectedSuit = null;
        let testResults = {};
        let currentTestMode = 'quick'; // 'quick' or 'special'
        
        // ESP32 Configuration
        const ESP32_IP = 'http://192.168.4.1';
        const CONTROL_MODE = 'http'; // 'mqtt' atau 'http' - ganti sesuai kebutuhan
        const ESP32_DEVICE_ID = 'esp32_001'; // Ganti sesuai device yang dipakai
        
        const statusIndicator = document.getElementById('statusIndicator');
        const statusText = document.getElementById('statusText');
        const injectBtn = document.getElementById('injectBtn');
        const recordBtn = document.getElementById('recordBtn');
        const stopBtn = document.getElementById('stopBtn');
        const btnText = document.getElementById('btnText');
        const voltageValue = document.getElementById('voltageValue');
        const currentValue = document.getElementById('currentValue');
        const resistanceValue = document.getElementById('resistanceValue');
        const timerDisplay = document.getElementById('timerDisplay');
        const timerValue = document.getElementById('timerValue');
        const namaSelect = document.getElementById('namaSelect');
        const measurementPoint = document.getElementById('measurementPoint');
        const infoSection = document.getElementById('infoSection');
        const resultsTable = document.getElementById('resultsTable');
        const saveAllBtn = document.getElementById('saveAllBtn');
        
        // Load suit list from localStorage
        function loadSuitList() {
            suitList = JSON.parse(localStorage.getItem('core_suit_list') || '[]');
            namaSelect.innerHTML = '<option value="">-- Pilih Nama Baju --</option>';
            if (!suitList.length) {
                namaSelect.innerHTML += '<option disabled>Tidak ada data. Tambahkan di Data Konduktif</option>';
                return;
            }
            suitList.forEach((suit, idx) => {
                namaSelect.innerHTML += `<option value="${idx}">${suit.nama} (${suit.kode})</option>`;
            });
        }
        
        // When suit selected
        namaSelect.addEventListener('change', function() {
            const idx = this.value;
            if (!idx) {
                selectedSuit = null;
                infoSection.style.display = 'none';
                testResults = {};
                renderResults();
                return;
            }
            selectedSuit = suitList[idx];
            document.getElementById('infoNama').textContent = selectedSuit.nama;
            document.getElementById('infoKode').textContent = selectedSuit.kode;
            document.getElementById('infoUpt').textContent = selectedSuit.unit || '-';
            infoSection.style.display = 'block';
            
            // Reset results for new suit
            testResults = {};
            renderResults();
        });
        
        // Render results table
        function renderResults() {
            if (Object.keys(testResults).length === 0) {
                resultsTable.innerHTML = '<tr><td colspan="3" style="padding:20px;text-align:center;color:#9ca3af;">Belum ada data pengujian</td></tr>';
                saveAllBtn.style.display = 'none';
                return;
            }
            
            let html = '';
            for (let i = 1; i <= 8; i++) {
                const point = 'R' + i;
                const result = testResults[point];
                if (result) {
                    const statusColor = parseFloat(result.resistance) > 200 ? '#ef4444' : '#10b981';
                    const statusText = parseFloat(result.resistance) > 200 ? 'Bad' : 'Good';
                    html += `
                        <tr style="border-bottom:1px solid #e5e7eb;">
                            <td style="padding:12px;font-weight:600;">${point}</td>
                            <td style="padding:12px;text-align:center;font-weight:600;font-size:16px;">${result.resistance}</td>
                            <td style="padding:12px;text-align:center;"><span style="background:${statusColor};color:white;padding:4px 12px;border-radius:4px;font-size:12px;font-weight:600;">${statusText}</span></td>
                        </tr>
                    `;
                } else {
                    html += `
                        <tr style="border-bottom:1px solid #e5e7eb;">
                            <td style="padding:12px;font-weight:600;">${point}</td>
                            <td colspan="2" style="padding:12px;text-align:center;color:#9ca3af;">Belum diuji</td>
                        </tr>
                    `;
                }
            }
            resultsTable.innerHTML = html;
            
            // Show save button if all 8 points tested
            if (Object.keys(testResults).length === 8) {
                saveAllBtn.style.display = 'inline-block';
            }
        }
        
        loadSuitList();
        
        // Mode Display Functions
        function updateModeDisplay() {
            const mode = document.getElementById('testMode').value;
            currentTestMode = mode;
            
            // Show/hide amplitude control based on mode with smooth animation
            const amplitudeControl = document.getElementById('amplitudeControl');
            if (mode === 'quick') {
                amplitudeControl.style.display = 'block';
                // Trigger animation
                setTimeout(() => {
                    amplitudeControl.style.maxHeight = '100px';
                    amplitudeControl.style.opacity = '1';
                }, 10);
            } else {
                amplitudeControl.style.maxHeight = '0';
                amplitudeControl.style.opacity = '0';
                setTimeout(() => {
                    amplitudeControl.style.display = 'none';
                }, 300);
            }
        }
        
        function updateAmplitude(value) {
            const v = Math.max(0, Math.min(100, parseInt(value || '0')));
            document.getElementById('amplitudeInput').value = v;
            document.getElementById('amplitudeSlider').value = v;
            
            // Send to ESP32 if test is active
            if (isInjecting) {
                fetch('/esp32/set_amplitude', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({value: v})
                }).catch(err => console.error('Failed to set amplitude:', err));
            }
        }
        
        function updateAmplitudeFromSlider(value) {
            updateAmplitude(value);
        }
        
        function changeAmplitude(delta) {
            const input = document.getElementById('amplitudeInput');
            const current = parseInt(input.value || '0');
            updateAmplitude(current + delta);
        }
        
        // MQTT Helper Function
        function sendMQTTCommand(action) {
            const topic = `cjack/${ESP32_DEVICE_ID}/control`;
            const message = JSON.stringify({ action: action });
            
            // Update device status to "sending"
            deviceIndicator.className = 'status-indicator active';
            deviceText.textContent = `ESP32: Sending ${action}...`;
            
            // Send via WebSocket to Golang server (yang akan publish ke MQTT)
            if (ws && ws.readyState === WebSocket.OPEN) {
                const mqttPayload = {
                    command: 'mqtt_publish',
                    topic: topic,
                    message: message
                };
                ws.send(JSON.stringify(mqttPayload));
                console.log('MQTT command sent:', mqttPayload);
                
                // Show visual feedback
                if (action === 'inject') {
                    showAlert('📡 MQTT: Injecting 200mA...', 'success');
                } else if (action === 'stop') {
                    showAlert('📡 MQTT: Stopping...', 'info');
                } else if (action === 'blink') {
                    showAlert('📡 MQTT: Blinking...', 'info');
                }
            } else {
                console.error('WebSocket not connected! Cannot send MQTT command.');
                showAlert('❌ Server tidak terhubung. Refresh halaman.', 'error');
                deviceIndicator.className = 'status-indicator inactive';
                deviceText.textContent = 'ESP32: Offline';
            }
        }
        
        // ESP32 Connection Check
        let esp32Connected = false;
        let currentESP32IP = ESP32_IP;
        
        async function checkESP32Connection() {
            try {
                // Ask the server to proxy status from ESP32
                const response = await fetch(`/esp32/status`, {
                    method: 'GET',
                    headers: { 'Accept': 'application/json' },
                    signal: AbortSignal.timeout(2000)
                });

                if (response.ok) {
                    const data = await response.json();
                    esp32Connected = true;
                    deviceIndicator.className = 'status-indicator active';
                    deviceText.textContent = 'ESP32: Connected';
                    return true;
                } else {
                    esp32Connected = false;
                    deviceIndicator.className = 'status-indicator inactive';
                    deviceText.textContent = 'ESP32: Disconnected';
                    return false;
                }
            } catch (error) {
                esp32Connected = false;
                deviceIndicator.className = 'status-indicator inactive';
                deviceText.textContent = 'ESP32: Error';
                return false;
            }
        }
        
        // Check ESP32 every 3 seconds
        setInterval(async () => {
            await checkESP32Connection();
        }, 3000);
        
        // Initial check
        checkESP32Connection();
        
        const deviceIndicator = document.getElementById('deviceIndicator');
        const deviceText = document.getElementById('deviceText');
        
        function connectWebSocket() {
            const protocol = window.location.protocol === 'https:' ? 'wss:' : 'ws:';
            const wsUrl = `${protocol}//${window.location.host}/ws`;
            ws = new WebSocket(wsUrl);
            ws.onopen = function() {
                console.log('WebSocket connected');
                statusIndicator.className = 'status-indicator active';
                statusText.textContent = 'Server: Connected';
            };
            ws.onmessage = function(event) {
                try {
                    const data = JSON.parse(event.data);
                    console.log('Received:', data);
                    
                    // Handle MQTT messages dari ESP32
                    if (data.topic && data.topic.includes('status')) {
                        const payload = JSON.parse(data.payload);
                        console.log('ESP32 Status:', payload);
                        
                        // Update device indicator
                        deviceIndicator.className = 'status-indicator active';
                        deviceText.textContent = `ESP32: ${payload.device || ESP32_DEVICE_ID}`;
                        
                        // Show LED status in alert
                        if (payload.injecting) {
                            showAlert('💡 ESP32 LED ON - Injecting!', 'success');
                        } else if (payload.blinking) {
                            showAlert('💫 ESP32 LED Blinking!', 'info');
                        }
                    }
                    
                    // Handle sensor data
                    if (data.topic && data.topic.includes('sensor')) {
                        const payload = JSON.parse(data.payload);
                        if (payload.voltage !== undefined) {
                            voltageValue.textContent = parseFloat(payload.voltage).toFixed(2);
                        }
                        if (payload.current !== undefined) {
                            currentValue.textContent = parseFloat(payload.current).toFixed(2);
                        }
                    }
                    
                    // Legacy sensor data format
                    if (data.voltage !== undefined) {
                        voltageValue.textContent = parseFloat(data.voltage).toFixed(2);
                    }
                    if (data.current !== undefined) {
                        currentValue.textContent = parseFloat(data.current).toFixed(2);
                    }
                    if (data.resistance !== undefined) {
                        resistanceValue.textContent = parseFloat(data.resistance).toFixed(2);
                    }
                } catch (e) {
                    console.error('Parse error:', e);
                }
            };
            ws.onerror = function(error) {
                console.error('WebSocket error:', error);
                statusIndicator.className = 'status-indicator inactive';
                statusText.textContent = 'Server: Error';
            };
            ws.onclose = function() {
                console.log('WebSocket disconnected');
                statusIndicator.className = 'status-indicator inactive';
                statusText.textContent = 'Server: Disconnected';
                deviceIndicator.className = 'status-indicator inactive';
                deviceText.textContent = 'ESP32: Offline';
                setTimeout(connectWebSocket, 3000);
            };
        }
        // Button: Inject - Start injection and monitoring (no timer yet)
        injectBtn.addEventListener('click', function() {
            // Validate before start
            if (!selectedSuit) {
                showAlert('Pilih nama baju terlebih dahulu!', 'warn');
                return;
            }
            if (!measurementPoint.value) {
                showAlert('Pilih titik pengukuran (R1-R8)!', 'warn');
                return;
            }
            if (testResults[measurementPoint.value]) {
                if (!confirm(`${measurementPoint.value} sudah diuji. Uji ulang?`)) {
                    return;
                }
            }
            startInjection();
        });
        
        // Button: Record - Start timer and recording
        recordBtn.addEventListener('click', function() {
            startRecording();
        });
        
        // Button: Stop - Stop everything and save result
        stopBtn.addEventListener('click', function() {
            stopInjection(true);
        });
        
        saveAllBtn.addEventListener('click', function() {
            if (!selectedSuit || Object.keys(testResults).length !== 8) {
                showAlert('Belum semua titik diuji! Selesaikan R1-R8 terlebih dahulu.', 'warn');
                return;
            }
            
            // Confirm before saving
            if (!confirm('Apakah Anda yakin ingin menyimpan semua data pengujian?')) {
                return;
            }
            
            // Disable button to prevent double click
            saveAllBtn.disabled = true;
            saveAllBtn.style.opacity = '0.6';
            saveAllBtn.style.cursor = 'not-allowed';
            saveAllBtn.textContent = '⏳ Menyimpan...';
            
            const record = {
                date: new Date().toISOString().slice(0, 10),
                code: selectedSuit.kode,
                upt: selectedSuit.unit || 'Pulogadung',
                name: selectedSuit.nama,
                waktu: '-',
                ukuran: selectedSuit.ukuran || '-',
                tahun: selectedSuit.tahun || '-',
                readings: {}
            };
            
            // Compile readings
            for (let i = 1; i <= 8; i++) {
                const point = 'R' + i;
                record.readings[point] = testResults[point].resistance;
            }
            
            // Check status
            const vals = Object.values(record.readings).map(x => Number(x));
            const bad = vals.some(v => !isNaN(v) && v > 200);
            record.status = bad ? 'Bad' : 'Good';
            record.rekomendasi = bad ? 'Cuci' : '-';
            
            // Save to history
            const history = JSON.parse(localStorage.getItem('core_history_v1') || '[]');
            history.unshift(record);
            localStorage.setItem('core_history_v1', JSON.stringify(history));
            
            showAlert('✅ Data berhasil disimpan! Redirect ke Histori...', 'success');
            setTimeout(() => location.href = 'histori.html', 1500);
        });
        async function startInjection() {
            console.log('=== START INJECTION ===');
            console.log('Mode:', currentTestMode);
            
            isInjecting = true;
            isRecording = false;
            
            // Update UI - hide Inject, show monitoring state
            injectBtn.style.display = 'none';
            btnText.textContent = '⚡ Injecting...';
            
            // Visual feedback - blink all cards
            const cards = document.querySelectorAll('.monitor-card');
            cards.forEach(card => {
                card.style.animation = 'pulse 1s infinite';
            });
            
            console.log('Starting monitoring interval...');
            
            // Send command to ESP32 - support MQTT dan HTTP
            if (CONTROL_MODE === 'mqtt') {
                // MQTT Mode - via WebSocket ke Golang server
                sendMQTTCommand('inject');
            } else if (CONTROL_MODE === 'http') {
                // HTTP Mode - call server proxy endpoints
                try {
                    let payload;
                    if (currentTestMode === 'special') {
                        // Special mode: auto-increment sampai 200mA
                        remainingTime = 15;
                        payload = { mode: 'special', duration: 15 };
                    } else {
                        // Quick mode: kirim amplitudo SESUAI SLIDER (default 0%)
                        const currentAmplitude = parseInt(document.getElementById('amplitudeInput').value) || 0;
                        payload = { mode: 'quick', amplitude: currentAmplitude };
                        remainingTime = 15;
                        console.log('Quick Test dengan amplitude:', currentAmplitude + '%');
                    }
                    
                    const res = await fetch('/esp32/inject', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(payload)
                    });

                    if (res.ok) {
                        const data = await res.text();
                        console.log('Proxy inject response:', data);
                        showAlert(`✅ ${currentTestMode === 'special' ? 'Special Test' : 'Quick Test'} dimulai`, 'success');
                    } else {
                        const txt = await res.text();
                        console.error('Proxy inject failed:', res.status, txt);
                        showAlert('⚠️ Gagal kirim perintah ke ESP32', 'warn');
                    }
                } catch (error) {
                    console.error('Proxy inject error:', error);
                    showAlert('❌ Gagal terhubung ke server proxy ESP32', 'error');
                }
            } else {
                showAlert('⚠️ ESP32 belum terhubung. Pastikan WiFi sama atau buka Config.', 'warn');
            }
            
            if (ws && ws.readyState === WebSocket.OPEN) {
                ws.send(JSON.stringify({
                    command: 'inject',
                    mode: currentTestMode,
                    value: currentTestMode === 'quick' ? parseInt(document.getElementById('amplitudeInput').value) : 200
                }));
            }
            
            // Start monitoring interval - fetch real data from ESP32
            intervalId = setInterval(async function() {
                try {
                    const res = await fetch('/esp32/status');
                    if (res.ok) {
                        const data = await res.json();
                        
                        // Parse dan tampilkan nilai (handle null/undefined)
                        const v = parseFloat(data.voltage) || 0;
                        const i = parseFloat(data.current) || 0;
                        const r = parseFloat(data.resistance) || 0;
                        
                        voltageValue.textContent = v.toFixed(2);
                        currentValue.textContent = (i * 1000).toFixed(2); // Convert A to mA
                        resistanceValue.textContent = r.toFixed(2);
                        
                        console.log('ESP32 Real Data:', {
                            voltage: v + 'V',
                            current: (i * 1000).toFixed(2) + 'mA',
                            resistance: r.toFixed(2) + 'Ω',
                            state: data.state,
                            amplitude: (data.amplitude * 100).toFixed(1) + '%'
                        });
                        
                        // Check if 200mA reached (180mA threshold to account for variance)
                        if (!isRecording && (i * 1000) >= 180) {
                            console.log('✅ 200mA REACHED! Showing Record button...');
                            recordBtn.style.display = 'inline-block';
                            stopBtn.style.display = 'inline-block';
                            showAlert('✅ 200mA tercapai! Klik RECORD untuk mulai timer', 'success');
                        }
                    } else {
                        console.error('Failed to fetch status:', res.status);
                    }
                } catch (err) {
                    console.error('Status fetch error:', err);
                }
            }, 500);
        }
        
        function updateTimerDisplay() {
            const minutes = Math.floor(remainingTime / 60);
            const seconds = remainingTime % 60;
            timerValue.textContent = `${String(minutes).padStart(2, '0')}:${String(seconds).padStart(2, '0')}`;
            
            // Change color when time is running out
            if (remainingTime <= 30) {
                timerValue.style.color = '#dc2626'; // Red
            } else if (remainingTime <= 60) {
                timerValue.style.color = '#f59e0b'; // Orange
            } else {
                timerValue.style.color = '#4f46e5'; // Blue
            }
        }
        
        function startRecording() {
            console.log('=== START RECORDING (TIMER) ===');
            isRecording = true;
            
            // Hide Record button, keep Stop visible
            recordBtn.style.display = 'none';
            
            // Show and start timer
            timerDisplay.style.display = 'block';
            updateTimerDisplay();
            
            // Start countdown
            timerInterval = setInterval(function() {
                remainingTime--;
                updateTimerDisplay();
                
                if (remainingTime <= 0) {
                    clearInterval(timerInterval);
                    stopInjection(true); // Auto stop with freeze when time up
                }
            }, 1000);
            
            showAlert('📊 Recording dimulai! Timer berjalan...', 'success');
        }
        
        async function stopInjection(freeze = false) {
            console.log('=== STOP INJECTION ===', {freeze, isRecording});
            
            isInjecting = false;
            isRecording = false;
            
            // Stop visual feedback
            const cards = document.querySelectorAll('.monitor-card');
            cards.forEach(card => {
                card.style.animation = 'none';
            });
            
            // Send stop to ESP32 - support MQTT dan HTTP
            if (CONTROL_MODE === 'mqtt') {
                sendMQTTCommand('stop');
            } else if (CONTROL_MODE === 'http') {
                try {
                    const res = await fetch('/esp32/stop', { method: 'POST' });
                    if (res.ok) {
                        showAlert('⏹️ Perintah stop diteruskan ke ESP32', 'info');
                    } else {
                        const txt = await res.text();
                        console.error('Proxy stop failed:', res.status, txt);
                        showAlert('⚠️ Gagal kirim stop ke ESP32', 'warn');
                    }
                } catch (error) {
                    console.error('Proxy stop error:', error);
                    showAlert('❌ Gagal terhubung ke server proxy ESP32', 'error');
                }
            }
            
            if (freeze) {
                // Auto-stop after 2 minutes - freeze the values and save
                const point = measurementPoint.value;
                const voltage = voltageValue.textContent;
                const current = currentValue.textContent;
                const resistance = resistanceValue.textContent;
                
                // Save result for this measurement point
                testResults[point] = {
                    voltage: voltage,
                    current: current,
                    resistance: resistance
                };
                
                renderResults();
                
                // Hide Record and Stop buttons
                recordBtn.style.display = 'none';
                stopBtn.style.display = 'none';
                
                // Show Inject button again with completion message
                injectBtn.style.display = 'inline-block';
                btnText.textContent = '✅ Selesai - ' + point + ' Tersimpan';
                injectBtn.disabled = true;
                injectBtn.style.cursor = 'not-allowed';
                injectBtn.style.opacity = '0.6';
                
                // Show completion message
                showAlert(`${point} selesai! Hambatan: ${resistance} Ω`, 'success');
                
                // Enable button again after 2 seconds
                setTimeout(function() {
                    injectBtn.disabled = false;
                    injectBtn.style.cursor = 'pointer';
                    injectBtn.style.opacity = '1';
                    btnText.textContent = '⚡ Inject 200mA';
                    
                    // Move to next measurement point
                    const currentIdx = parseInt(point.substring(1));
                    if (currentIdx < 8) {
                        measurementPoint.value = 'R' + (currentIdx + 1);
                        showAlert('✅ ' + point + ' selesai! Lanjut ke ' + measurementPoint.value, 'info');
                    } else {
                        measurementPoint.value = '';
                        showAlert('🎉 Semua titik R1-R8 sudah selesai! Klik tombol "Selesai" untuk menyimpan.', 'success');
                        // Blink the save button to draw attention
                        let blinkCount = 0;
                        const blinkInterval = setInterval(function() {
                            saveAllBtn.style.transform = blinkCount % 2 === 0 ? 'scale(1.05)' : 'scale(1)';
                            blinkCount++;
                            if (blinkCount >= 6) {
                                clearInterval(blinkInterval);
                                saveAllBtn.style.transform = 'scale(1)';
                            }
                        }, 300);
                    }
                }, 2000);
            } else {
                // Manual stop - reset UI to initial state
                recordBtn.style.display = 'none';
                stopBtn.style.display = 'none';
                injectBtn.style.display = 'inline-block';
                btnText.textContent = '⚡ Inject 200mA';
                voltageValue.textContent = '0.00';
                currentValue.textContent = '0.00';
                resistanceValue.textContent = '0.00';
            }
            
            // Clear intervals
            if (intervalId) {
                clearInterval(intervalId);
                intervalId = null;
            }
            if (timerInterval) {
                clearInterval(timerInterval);
                timerInterval = null;
            }
            
            // Hide timer
            timerDisplay.style.display = 'none';
            
            if (ws && ws.readyState === WebSocket.OPEN) {
                ws.send(JSON.stringify({
                    command: 'stop'
                }));
            }
        }
        
        function showAlert(message, type = 'info') {
            const colors = {
                info: 'bg-blue-500',
                success: 'bg-green-500',
                warn: 'bg-yellow-500',
                error: 'bg-red-500'
            };
            const bgClass = colors[type] || colors.info;
            const $alert = $('<div/>')
                .addClass(`fixed top-4 right-4 ${bgClass} text-white px-4 py-3 rounded shadow-lg`)
                .css({display:'none', zIndex:9999})
                .text(message);
            $('body').append($alert);
            $alert.fadeIn(200).delay(3000).fadeOut(300, function() {
                $alert.remove();
            });
        }
        
        // Initialize mode display on load
        updateModeDisplay();
        connectWebSocket();
    </script>
            </div>
        </main>
    </div>
</body>
</html>
