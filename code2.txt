// LANJUTAN DARI PART 1 - Fungsi handleRoot() dan seterusnya

void handleRoot() {
  // Stop auto injection when returning to injection dashboard
  if (autoInjectionMode) {
    stopAutoInjection();
  }

  String html = R"(
<!DOCTYPE html>
<html>
<head>
    <title>CJack</title>
    <meta charset='UTF-8'>
    <meta name='viewport' content='width=device-width, initial-scale=1.0'>
    <style>
        body {
            font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
            margin: 0;
            padding: 0;
            background: radial-gradient(circle at top left, #1e293b, #020617);
            color: #e5e7eb;
        }
        .container {
            max-width: 900px;
            margin: 24px auto;
            background: linear-gradient(145deg, #0b1220, #020617);
            padding: 20px 18px 26px;
            border-radius: 16px;
            box-shadow:
                0 18px 40px rgba(15, 23, 42, 0.8),
                0 0 0 1px rgba(148, 163, 184, 0.15);
            border: 1px solid rgba(148, 163, 184, 0.35);
        }
        .header {
            position: relative;
            text-align: center;
            margin-bottom: 24px;
            padding-bottom: 8px;
            border-bottom: 1px solid rgba(148, 163, 184, 0.3);
        }
        .header h1 {
            margin: 0;
            font-size: 24px;
            letter-spacing: 0.03em;
            color: #e5e7eb;
        }
        .header small {
            display: block;
            margin-top: 4px;
            color: #9ca3af;
            font-size: 12px;
        }
        .settings-top-left {
            position: absolute;
            left: 0;
            top: 0;
            padding: 6px 12px;
            background: rgba(15, 23, 42, 0.9);
            color: #e5e7eb;
            border-radius: 999px;
            font-size: 11px;
            text-decoration: none;
            border: 1px solid rgba(148, 163, 184, 0.5);
        }
        .settings-top-left:hover {
            background: rgba(30, 64, 175, 0.9);
            border-color: rgba(129, 140, 248, 0.9);
        }
        .wifi-status {
            padding: 10px 14px;
            border-radius: 999px;
            margin: 10px 0 18px;
            text-align: center;
            font-size: 13px;
            display: inline-flex;
            align-items: center;
            gap: 8px;
        }
        .wifi-connected {
            background: rgba(22, 163, 74, 0.12);
            color: #bbf7d0;
            border: 1px solid rgba(22, 163, 74, 0.5);
        }
        .wifi-disconnected {
            background: rgba(248, 113, 113, 0.12);
            color: #fecaca;
            border: 1px solid rgba(248, 113, 113, 0.5);
        }
        .wifi-status strong {
            font-weight: 600;
        }
        .current-values {
            background: radial-gradient(circle at top, rgba(30, 64, 175, 0.15), rgba(15, 23, 42, 0.9));
            padding: 16px 14px;
            border-radius: 12px;
            margin: 10px 0 18px;
            border: 1px solid rgba(148, 163, 184, 0.4);
        }
        .current-values h3 {
            margin: 0 0 10px;
            font-size: 15px;
            color: #e5e7eb;
        }
        .value-item {
            display: inline-block;
            margin: 6px 10px;
            text-align: center;
            min-width: 80px;
        }
        .value-label {
            font-weight: 500;
            color: #9ca3af;
            font-size: 12px;
            margin-bottom: 2px;
        }
        .value-display {
            font-size: 18px;
            font-weight: 600;
            color: #e5e7eb;
        }
        .form-group {
            margin: 16px 0;
        }
        label {
            display: block;
            margin-bottom: 6px;
            font-weight: 600;
            font-size: 13px;
            color: #d1d5db;
        }
        select,
        input[type='text'],
        input[type='password'],
        input[type='number'] {
            width: 100%;
            padding: 9px 10px;
            border: 1px solid rgba(148, 163, 184, 0.6);
            border-radius: 8px;
            box-sizing: border-box;
            background: rgba(15, 23, 42, 0.9);
            color: #e5e7eb;
            font-size: 13px;
        }
        select:focus,
        input[type='text']:focus,
        input[type='password']:focus,
        input[type='number']:focus {
            outline: none;
            border-color: rgba(129, 140, 248, 0.9);
            box-shadow: 0 0 0 1px rgba(129, 140, 248, 0.6);
        }
        .btn {
            padding: 10px 18px;
            margin: 8px 6px;
            border: none;
            border-radius: 999px;
            cursor: pointer;
            font-size: 13px;
            font-weight: 600;
            letter-spacing: 0.02em;
            transition: transform 0.08s ease, box-shadow 0.08s ease, background 0.15s ease;
        }
        .btn-primary {
            background: linear-gradient(135deg, #2563eb, #4f46e5);
            color: white;
            box-shadow: 0 8px 18px rgba(37, 99, 235, 0.35);
        }
        .btn-primary:hover {
            background: linear-gradient(135deg, #1d4ed8, #4338ca);
            transform: translateY(-1px);
            box-shadow: 0 10px 22px rgba(59, 130, 246, 0.5);
        }
        .btn-secondary {
            background: rgba(31, 41, 55, 0.95);
            color: #e5e7eb;
            border: 1px solid rgba(148, 163, 184, 0.6);
        }
        .btn-secondary:hover {
            background: rgba(55, 65, 81, 0.95);
        }
        .btn-success {
            background: linear-gradient(135deg, #16a34a, #22c55e);
            color: white;
            box-shadow: 0 8px 18px rgba(34, 197, 94, 0.35);
        }
        .btn-success:hover {
            background: linear-gradient(135deg, #15803d, #16a34a);
        }
        .btn-stop {
            background: linear-gradient(135deg, #b91c1c, #ef4444);
            color: white;
            box-shadow: 0 8px 18px rgba(248, 113, 113, 0.35);
        }
        .btn-stop:hover {
            background: linear-gradient(135deg, #991b1b, #dc2626);
        }
        .btn:active {
            transform: translateY(0);
            box-shadow: 0 4px 10px rgba(15, 23, 42, 0.5);
        }
        .status-panel {
            padding: 12px 12px;
            border-radius: 10px;
            margin: 16px 0;
            font-size: 13px;
        }
        .status-success {
            background: rgba(22, 163, 74, 0.08);
            border: 1px solid rgba(22, 163, 74, 0.5);
            color: #bbf7d0;
        }
        .status-error {
            background: rgba(248, 113, 113, 0.08);
            border: 1px solid rgba(248, 113, 113, 0.5);
            color: #fecaca;
        }
        .status-info {
            background: rgba(59, 130, 246, 0.08);
            border: 1px solid rgba(59, 130, 246, 0.5);
            color: #bfdbfe;
        }
        .button-group {
            text-align: center;
            margin: 18px 0;
        }
        .section-title {
            margin-top: 22px;
            font-size: 15px;
            font-weight: 600;
            color: #e5e7eb;
        }

        /* Pretty control cards for amplitude & timer */
        .control-card {
            background: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 8px;
            padding: 15px 15px 12px;
            margin: 15px 0;
            box-shadow: 0 2px 4px rgba(0,0,0,0.03);
        }
        .control-title {
            font-size: 14px;
            font-weight: bold;
            color: #495057;
            margin-bottom: 6px;
        }
        .control-subtitle {
            font-size: 12px;
            color: #6c757d;
            margin-top: 6px;
            text-align: center;
        }
        .numeric-control {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            margin-top: 6px;
        }
        .slider-container {
            margin-top: 10px;
        }
        .slider-inline {
            width: 100%;
        }
        .numeric-value {
            width: 80px;
            text-align: center;
            padding: 10px 8px;
            border-radius: 6px;
            border: 1px solid #ced4da;
            font-size: 18px;
            font-weight: bold;
            color: #333;
            background: #ffffff;
            box-shadow: inset 0 1px 2px rgba(0,0,0,0.05);
            box-sizing: border-box;
        }
        .numeric-btn {
            width: 56px;
            height: 56px;
            border-radius: 18px;
            border: none;
            font-size: 26px;
            font-weight: bold;
            color: #ffffff;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 3px 6px rgba(0,0,0,0.18);
            transition: background 0.15s ease, transform 0.05s ease, box-shadow 0.05s ease;
        }
        .numeric-btn:active {
            transform: translateY(1px);
            box-shadow: 0 1px 2px rgba(0,0,0,0.2);
        }
        .numeric-btn.dec {
            background: #6c757d;
        }
        .numeric-btn.dec:hover {
            background: #5a6268;
        }
        .numeric-btn.inc {
            background: #007bff;
        }
        .numeric-btn.inc:hover {
            background: #0056b3;
        }
    </style>
</head>
<body>
    <div class='container'>
        <div class='header'>
            <a href='/settings' class='settings-top-left'>Settings</a>
            <h1>CJack</h1>
        </div>
        
        <div id='wifiStatus' class='wifi-status wifi-disconnected'>
            <strong>WiFi Status: </strong><span id='wifiText'>Disconnected</span>
        </div>
        
        <div class='current-values'>
            <h3>Current Values</h3>
            <div class='value-item'>
                <div class='value-label'>Voltage</div>
                <div class='value-display' id='voltageValue'>0.00 V</div>
            </div>
            <div class='value-item'>
                <div class='value-label'>Current</div>
                <div class='value-display' id='currentValue'>0.00 A</div>
            </div>
            <div class='value-item'>
                <div class='value-label'>Resistance</div>
                <div class='value-display' id='resistanceValue'>0.00 Ω</div>
            </div>
            <div class='value-item'>
                <div class='value-label'>Amplitude</div>
                <div class='value-display' id='amplitudeValue'>0%</div>
            </div>
        </div>

        <div id='injectionSection'>
            <h3 class='section-title'>Injection Control</h3>
            <div class='form-group'>
                <label for='testMode'>Test Mode:</label>
                <select id='testMode' onchange='updateModeDisplay()'>
                    <option value='quick'>Quick Test</option>
                    <option value='special'>Spesial Conduct Suit Test</option>
                </select>
            </div>
            
            <div id='modeDisplay' class='status-panel status-info'>
                <strong>Current Mode:</strong> <span id='currentModeText'>Quick Test</span>
                <p id='modeDescription'>Tes cepat dengan kontrol amplitudo manual.</p>
            </div>
            
            <div class='control-card' id='quickControl'>
                <div class='control-title'>Quick Test Amplitude</div>
                <div class='numeric-control'>
                    <button type='button' class='numeric-btn dec' onclick='changeQuickAmplitude(-1)'>-</button>
                    <input type='number' id='quickAmplitude' class='numeric-value' min='0' max='100' step='1' value='0' onchange='updateQuickAmplitude(this.value)'>
                    <button type='button' class='numeric-btn inc' onclick='changeQuickAmplitude(1)'>+</button>
                </div>
                <div class='slider-container'>
                    <input type='range' id='quickAmplitudeSlider' class='slider-inline' min='0' max='100' step='1' value='0' oninput='updateQuickFromSlider(this.value)'>
                </div>
                <div class='control-subtitle'>Atur besar injeksi (%) dengan tombol - / + atau geser slide.</div>
            </div>
            <div class='control-card' id='specialControl' style='display: none;'>
                <div class='control-title'>Spesial Conduct Suit Timer</div>
                <div class='numeric-control'>
                    <button type='button' class='numeric-btn dec' onclick='changeSpecialDuration(-5)'>-</button>
                    <input type='number' id='specialDuration' class='numeric-value' min='1' max='3600' step='1' value='120'>
                    <button type='button' class='numeric-btn inc' onclick='changeSpecialDuration(5)'>+</button>
                </div>
                <div class='control-subtitle'>Durasi uji dalam detik. Tombol - / + mengubah 5 detik.</div>
            </div>
            
            <div class='button-group'>
                <button class='btn btn-primary' id='startBtn' onclick='startTest()'>Start Test</button>
                <button class='btn btn-stop' id='stopBtn' onclick='stopTest()' style='display: none;'>Stop</button>
            </div>
            
            <form id='dataForm' onsubmit='submitToCloud(event)'>
                <div class='form-group'>
                    <label for='upt'>UPT:</label>
                    <input type='text' id='upt' name='upt' required>
                </div>
                <div class='form-group'>
                    <label for='nip'>NIP:</label>
                    <input type='text' id='nip' name='nip' required>
                </div>
                <div class='form-group'>
                    <label for='kodeSuit'>KODE_SUIT:</label>
                    <input type='text' id='kodeSuit' name='kodeSuit' required>
                </div>
                <div class='form-group'>
                    <label for='hasilR'>R (hasil uji):</label>
                    <input type='text' id='hasilR' name='hasilR' readonly>
                </div>
                <button type='submit' class='btn btn-success'>Submit Test Results</button>
            </form>
            
            <div id='submissionStatus' class='status-panel' style='display: none;'></div>
        </div>
    </div>

    <script>
        let currentTestMode = 'quick';
        let testActive = false;

        function updateModeDisplay() {
            const mode = document.getElementById('testMode').value;
            const display = document.getElementById('modeDisplay');
            const currentModeText = document.getElementById('currentModeText');
            const modeDescription = document.getElementById('modeDescription');
            const quickControl = document.getElementById('quickControl');
            const specialControl = document.getElementById('specialControl');
            
            currentTestMode = mode;
            
            if (mode === 'quick') {
                currentModeText.textContent = 'Quick Test';
                modeDescription.textContent = 'Tes cepat dengan kontrol amplitudo manual.';
                display.className = 'status-panel status-info';
                quickControl.style.display = 'block';
                specialControl.style.display = 'none';
            } else if (mode === 'special') {
                currentModeText.textContent = 'Spesial Conduct Suit Test';
                modeDescription.textContent = 'Amplitude naik otomatis sampai 200mA lalu countdown sesuai timer.';
                display.className = 'status-panel status-info';
                quickControl.style.display = 'none';
                specialControl.style.display = 'block';
            }
        }

        function updateQuickAmplitude(value) {
            if (currentTestMode !== 'quick') return;
            const v = Math.max(0, Math.min(100, parseInt(value || '0')));
            const input = document.getElementById('quickAmplitude');
            const slider = document.getElementById('quickAmplitudeSlider');
            const normalized = isNaN(v) ? 0 : v;

            if (input) {
                input.value = normalized;
            }
            if (slider) {
                slider.value = normalized;
            }

            if (testActive) {
                fetch('/set_amplitude?value=' + normalized)
                    .then(response => response.text())
                    .then(data => console.log('Quick amplitude updated:', normalized));
            }
        }

        function updateQuickFromSlider(value) {
            if (currentTestMode !== 'quick') return;
            const v = Math.max(0, Math.min(100, parseInt(value || '0')));
            const slider = document.getElementById('quickAmplitudeSlider');
            const normalized = isNaN(v) ? 0 : v;

            if (slider) {
                slider.value = normalized;
            }
            // Delegasikan ke updateQuickAmplitude supaya input angka ikut sinkron dan,
            // kalau testActive, nilai juga terkirim ke alat.
            updateQuickAmplitude(normalized);
        }

        function changeQuickAmplitude(delta) {
            const input = document.getElementById('quickAmplitude');
            if (!input) return;
            const current = parseInt(input.value || '0');
            let next = isNaN(current) ? 0 : current + delta;
            if (next < 0) next = 0;
            if (next > 100) next = 100;
            // Hanya ganti lewat fungsi umum supaya slider dan backend ikut sinkron
            updateQuickAmplitude(next);
        }

        function changeSpecialDuration(delta) {
            const input = document.getElementById('specialDuration');
            if (!input) return;
            const current = parseInt(input.value || '0');
            let next = isNaN(current) ? 0 : current + delta;
            if (next < 1) next = 1;
            if (next > 3600) next = 3600;
            input.value = next;
        }

        function startTest() {
            if (currentTestMode === 'special') {
                const durationInput = document.getElementById('specialDuration');
                const durationSec = parseInt(durationInput.value || '0');
                if (!durationSec || durationSec <= 0) {
                    alert('Masukkan waktu timer (detik) yang valid untuk Spesial Conduct Suit Test.');
                    return;
                }
                fetch('/api/auto-injection?action=start&duration=' + durationSec, {method: 'POST'})
                    .then(response => response.json())
                    .then(data => {
                        if (data.success) {
                            testActive = true;
                            document.getElementById('startBtn').style.display = 'none';
                            document.getElementById('stopBtn').style.display = 'inline-block';
                            updateStatusMessage('Spesial Conduct Suit Test dimulai. Menambah amplitude sampai 200mA...');
                        }
                    });
            } else { // Quick Test
                const ampInput = document.getElementById('quickAmplitude');
                const amp = Math.max(0, Math.min(100, parseInt(ampInput.value || '0')));
                ampInput.value = amp;
                fetch('/set_amplitude?value=' + amp)
                    .then(response => response.text())
                    .then(() => {
                        return fetch('/set_amplitude?state=RUN');
                    })
                    .then(response => response.text())
                    .then(() => {
                        testActive = true;
                        document.getElementById('startBtn').style.display = 'none';
                        document.getElementById('stopBtn').style.display = 'inline-block';
                        // Setelah Quick Test dimulai, input angka dikunci (hanya +/- yang boleh ubah)
                        const ampEl = document.getElementById('quickAmplitude');
                        if (ampEl) {
                            ampEl.readOnly = true;
                        }
                        updateStatusMessage('Quick Test berjalan dengan amplitude ' + amp + '%.');
                    });
            }
        }

        function stopTest() {
            if (currentTestMode === 'special') {
                fetch('/api/auto-injection?action=stop', {method: 'POST'})
                    .then(response => response.json())
                    .then(data => {
                        testActive = false;
                        resetButtons();
                        updateStatusMessage('Spesial Conduct Suit Test dihentikan.');
                    });
            } else { // Quick Test
                fetch('/set_amplitude?state=STOP')
                    .then(response => response.text())
                    .then(data => {
                        testActive = false;
                        // Saat STOP, kembalikan amplitude ke 0 dan buka lagi input angka
                        const ampEl = document.getElementById('quickAmplitude');
                        if (ampEl) {
                            ampEl.readOnly = false;
                            ampEl.value = 0;
                        }
                        resetButtons();
                        updateStatusMessage('Quick Test dihentikan.');
                    });
            }
        }

        function resetButtons() {
            document.getElementById('startBtn').style.display = 'inline-block';
            document.getElementById('stopBtn').style.display = 'none';
        }

        function updateStatusMessage(message) {
            const display = document.getElementById('modeDisplay');
            display.className = 'status-panel status-success';
            document.getElementById('modeDescription').textContent = message;
        }

        function showForm() {
            document.getElementById('dataForm').style.display = 'block';
        }

        function submitToCloud(event) {
            event.preventDefault();

            const formData = new FormData(document.getElementById('dataForm'));
            // Hanya kirim 4 item ke cloud: UPT, NIP, KODE_SUIT, R
            const data = {
                UPT: formData.get('upt'),
                NIP: formData.get('nip'),
                KODE_SUIT: formData.get('kodeSuit'),
                R: 0
            };

            // Ambil nilai R (resistance) terakhir dari alat
            fetch('/status')
                .then(response => response.json())
                .then(statusData => {
                    data.R = statusData.resistance;

                    const rField = document.getElementById('hasilR');
                    if (rField) {
                        rField.value = statusData.resistance.toFixed(2);
                    }

                    return fetch('/api/submit-data', {
                        method: 'POST',
                        headers: {'Content-Type': 'application/json'},
                        body: JSON.stringify(data)
                    });
                })
                .then(response => response.json())
                .then(result => {
                    const status = document.getElementById('submissionStatus');
                    if (result.success) {
                        status.className = 'status-panel status-success';
                        status.textContent = 'Data submitted successfully! Reference ID: ' + result.referenceId;
                        document.getElementById('dataForm').reset();
                    } else {
                        status.className = 'status-panel status-error';
                        status.textContent = 'Failed to submit data: ' + result.message;
                    }
                    status.style.display = 'block';
                })
                .catch(error => {
                    const status = document.getElementById('submissionStatus');
                    status.className = 'status-panel status-error';
                    status.textContent = 'Error submitting data: ' + error.message;
                    status.style.display = 'block';
                });
        }

        function updateReadings() {
            fetch('/status')
                .then(response => response.json())
                .then(data => {
                    document.getElementById('voltageValue').textContent = data.voltage.toFixed(2) + ' V';
                    document.getElementById('currentValue').textContent = data.current.toFixed(2) + ' A';
                    document.getElementById('resistanceValue').textContent = data.resistance.toFixed(2) + ' Ω';
                    document.getElementById('amplitudeValue').textContent = (data.amplitude * 100).toFixed(0) + '%';
                    const quickInput = document.getElementById('quickAmplitude');
                    // Hanya sinkronkan nilai kotak Quick Test dari alat saat test aktif di Quick mode,
                    // supaya sebelum start user bebas mengisi dan tidak langsung ditimpa lagi.
                    if (quickInput && testActive && currentTestMode === 'quick') {
                        quickInput.value = (data.amplitude * 100).toFixed(0);
                    }

                    const rField = document.getElementById('hasilR');
                    if (rField) {
                        rField.value = data.resistance.toFixed(2);
                    }

                    if (data.wifiConnected) {
                        document.getElementById('wifiStatus').className = 'wifi-status wifi-connected';
                        document.getElementById('wifiText').textContent = 'Connected to ' + data.wifiSSID;
                    } else {
                        document.getElementById('wifiStatus').className = 'wifi-status wifi-disconnected';
                        document.getElementById('wifiText').textContent = 'Disconnected';
                    }
                })
                .catch(error => {
                    console.error('Error fetching status:', error);
                });
        }

        updateReadings();
        setInterval(updateReadings, 1000);
        updateModeDisplay();
    </script>
</body>
</html>
  )";

  server.send(200, "text/html", html);
}

// =============== FUNGSI-FUNGSI LAINNYA (SETTINGS, WIFI, CLOUD, DLL) ===============
// Saya akan lanjutkan di bagian ini. Karena terlalu panjang, ini adalah ringkasan struktur:
// - handleSettings() - halaman settings WiFi dan Cloud
// - loadSettingsFromMemory() - load dari NVS
// - saveSettingsToMemory() - simpan ke NVS
// - handleWiFiSettings() - API untuk update WiFi
// - handleCloudSettings() - API untuk update cloud server
// - handleAutoInjection() - API untuk auto injection mode
// - sendDataToCloud() - API untuk submit data
// - sendDataToCloudServer() - fungsi kirim HTTP POST
// - handleGetStatus() - API status device
// - handleSetAmplitude() - API set amplitude
// - stopAutoInjection() - stop auto injection
// - handleWiFiInterference() - dual WiFi mode
// - updateTimeBasedLamp() - LED blinking
// - displayWebServerMode() - tampilan TFT saat web mode
// - drawHeader(), drawFrame() - TFT UI
// - updateValues(), updateTime(), updateStatus() - TFT updates
// - updateLEDsAndRelay() - kontrol LED dan relay
// - executeMenu() - eksekusi menu
// - readJSY1050() - baca sensor
// - handleButtons() - tombol fisik
// - handleRotaryEncoder() - rotary encoder
// - updateDAC() - update DAC output
// - setup() - initialization
// - loop() - main loop

// Silakan copy semua fungsi dari file asli main.cpp mulai dari handleSettings() 
// sampai akhir file (loop function) ke file ini untuk melengkapi code.
