#include <Arduino.h>
#include <TFT_eSPI.h>
#include <ezButton.h>
#include <ModbusMaster.h>
#include <WiFi.h>
#include <WebServer.h>
#include <DNSServer.h>
#include <HTTPClient.h>
#include <ArduinoJson.h>
#include <Preferences.h>

// ------------------- TFT Setup -------------------
TFT_eSPI tft = TFT_eSPI();  // ST7789 240x240

// ------------------- Tombol -------------------
ezButton keyUp(26);
// ezButton keyDown(35);

// ------------------- JSY1050 Setup -------------------
#define RXD_JSY 16
#define TXD_JSY 17
HardwareSerial SerialJSY(2);
ModbusMaster node;

// ------------------- LED & Relay -------------------
#define LED_RUNTIME 13
#define LED_STOP    27
#define LED_RUN     14
#define RELAY_PIN   32
// Rotary Encoder Pinout pada ESP32
#define CLK_PIN 21   // Pilih GPIO 21
#define DT_PIN  19   // Pilih GPIO 19
#define SW_PIN  5    // Pilih GPIO 5
#define WEB_SERVER_SWITCH 22  // Web server mode switch (active low)

// DAC Pin
#define DAC_PIN 25   // GPIO 25 untuk DAC output

 // ------------------- WiFi & Web Server -------------------
const char* ap_ssid = "CJack_ESP32";      // Access Point SSID
const char* ap_password = "12345678";     // Access Point Password (8+ chars)
WebServer server(80);
bool webServerMode = false;

// DNS server untuk memetakan nama domain lokal (mis. cjack.com) ke IP AP (192.168.4.1)
const byte DNS_PORT = 53;
DNSServer dnsServer;

// WiFi Configuration to avoid interference
bool dualWiFiMode = false;  // Flag for dual WiFi operation
IPAddress localIP(192, 168, 4, 1);  // Fixed IP for AP mode
IPAddress gateway(192, 168, 4, 1);
IPAddress subnet(255, 255, 255, 0);

// WiFi Settings
String wifiSSID = "";
String wifiPassword = "";
String cloudServerAddress = "https://api.example.com/submit-data";

// WiFi Connection Status
bool wifiConnected = false;
bool wifiStationMode = false;

// ---------------- STARFIELD CONFIG ----------------
#define NSTARS 1024
uint8_t sx[NSTARS], sy[NSTARS], sz[NSTARS];
uint8_t za, zb, zc, zx;
inline uint8_t rng8() {
  zx++;
  za = (za ^ zc ^ zx);
  zb = (zb + za);
  zc = ((zc + (zb >> 1)) ^ za);
  return zc;
}

// ---------------- UI COLORS & Layout ----------------
float ampValue = 0.0;        // amplitude awal 0%
float stepSize = 0.01;       // langkah 1%
int lastCLK = HIGH;
#define BG_COLOR TFT_BLACK // black background
#define COLOR_V TFT_RED // red for voltage
#define COLOR_I TFT_GREEN // green for current
#define COLOR_R TFT_CYAN // sky blue for resistance
#define STATUS_RUN TFT_GREEN // green for run
#define STATUS_READY TFT_CYAN // blue sky for ready
#define STATUS_HOLD tft.color565(128, 128, 128) // gray for hold
#define OUTLINE TFT_WHITE // white outline
const int WIDTH = 240;
const int HEIGHT = 240;
int lastSecond = -1;
// ------------------- Variabel -------------------
float voltage = 0.0f, currentA = 0.0f, resistanceVal = 0.0f;
unsigned long lastRead = 0;
const unsigned long READ_INTERVAL = 500; // ms

enum State { READY, RUN, STOPPED };
State systemState = STOPPED;  // posisi awal STOPPED

enum MenuItem { MENU_RUNTIME = 0, MENU_RUN = 1, MENU_STOP = 2 };
MenuItem currentMenu = MENU_STOP;  // posisi awal di STOP
const int MENU_COUNT = 3;

unsigned long countdownStart = 0;
unsigned long countdownDuration = 0;
bool countdownActive = false;

 // 200mA Injection Variables
bool autoInjectionMode = false;
bool targetReached = false;
// JSY current is in Amperes, so 200mA = 0.2A
float targetCurrent = 0.2f; // 200mA
float autoIncrementStep = 0.005f; // 0.5% increment (in amplitude units)
unsigned long autoIncrementDelay = 5000; // 5 seconds between increments
// User-configurable countdown for special test mode (milliseconds)
unsigned long userCountdownDuration = 2 * 60 * 1000UL; // default 120s

// Time-based lamp variables
bool lampTimeBased = false;
unsigned long lampStartTime = 0;
unsigned long lampDuration = 0; // in milliseconds
bool lampState = false;
unsigned long lastLampToggle = 0;
const unsigned long LAMP_BLINK_INTERVAL = 1000; // Blink every 1 second

// Data submission form variables
String uptValue = "";
String namaValue = "";
String kodeConductiveValue = "";
bool dataSubmitted = false;
String lastSubmissionStatus = "";

// ------------------- Layout -------------------
#define X_LABEL  20
#define X_VALUE  180
#define Y_V      55
#define Y_I      95
void handleRotaryEncoder();
void updateDAC();
#define Y_R      140
#define Y_TIME   185
#define Y_STATUS 215

// ------------------- Prototypes -------------------
void drawHeader();
void drawFrame();
void updateValues(float v, float i, float r);
void updateTime();
void updateStatus();
void executeMenu(MenuItem menu);
void readJSY1050();
void handleButtons();
void updateLEDsAndRelay();
void starfieldIntro();
void handleWebServer();
void handleRoot();
void handleSetAmplitude();
void handleGetStatus();
void checkWebServerSwitch();
void displayWebServerMode();
void refreshWebServerDisplay();
void handleSettings();
void handleMainMenu();
void handleInjection();
void handleInjection();
void handleDataSubmission();
void connectToWiFi();
void handleWiFiSettings();
void handleCloudSettings();
void handleAutoInjection();
void sendDataToCloud();
void loadSettingsFromMemory();
void saveSettingsToMemory(const String& ssid, const String& password, const String& cloudServer);
void stopAutoInjection();
void handleWiFiInterference();
void updateTimeBasedLamp();
bool sendDataToCloudServer(const String& jsonData, String& response);
void handleInjection();

// ------------------- STARFIELD INTRO -------------------
void starfieldIntro() {
  tft.fillScreen(TFT_BLACK);
  tft.setTextColor(TFT_WHITE, TFT_BLACK);
  tft.setTextFont(2);
  tft.drawCentreString("CJack", 120, 100, 4);
  for (int k = 0; k < 160; k++) {
    uint8_t spawn = 255 - (k % 200);
    for (int i = 0; i < NSTARS; i++) {
      if (sz[i] <= 1) {
        sx[i] = (120 - 80) + rng8();
        sy[i] = rng8(); // 0..255
        sz[i] = spawn--;
      } else {
        int oldx = ((int)sx[i] - 120) * 256 / (sz[i] < 1 ? 1 : sz[i]) + 120;
        int oldy = ((int)sy[i] - 120) * 256 / (sz[i] < 1 ? 1 : sz[i]) + 120;
        if (oldx >= 0 && oldy >= 0 && oldx < WIDTH && oldy < HEIGHT)
          tft.drawPixel(oldx, oldy, TFT_BLACK);
        sz[i] -= 2;
        if (sz[i] > 1) {
          int x = ((int)sx[i] - 120) * 256 / (sz[i] < 1 ? 1 : sz[i]) + 120;
          int y = ((int)sy[i] - 120) * 256 / (sz[i] < 1 ? 1 : sz[i]) + 120;
          if (x >= 0 && y >= 0 && x < WIDTH && y < HEIGHT) {
            uint8_t c = 255 - sz[i];
            tft.drawPixel(x, y, tft.color565(c, c, c));
          } else sz[i] = 0;
        }
      }
    }
    delay(12);
  }
  delay(200);
  tft.fillScreen(BG_COLOR);
}

void checkWebServerSwitch() {
  static bool lastSwitchState = HIGH;
  static unsigned long lastDebounceTime = 0;
  static unsigned long lastDebugTime = 0;
  static bool switchHandled = false; // Track if switch press has been handled
  
  bool currentSwitchState = digitalRead(WEB_SERVER_SWITCH);
  
  // Debounce switch (ignore rapid state changes)
  if (currentSwitchState != lastSwitchState) {
    lastDebounceTime = millis();
    switchHandled = false; // Reset when state changes
  }
  
  // Debug output every 2 seconds
  if (millis() - lastDebugTime > 2000) {
    Serial.print("Switch pin 22 state: ");
    Serial.println(currentSwitchState ? "HIGH" : "LOW");
    Serial.print("Web server mode: ");
    Serial.println(webServerMode ? "ON" : "OFF");
    lastDebugTime = millis();
  }
  
  // Only process state change after debounce period (50ms)
  if ((millis() - lastDebounceTime) > 50 && !switchHandled) {
    // Handle switch press (LOW state)
    if (currentSwitchState == LOW) {
      Serial.println("Switch pressed! Activating web server mode...");
      webServerMode = true;
      Serial.print("Web server mode: ");
      Serial.println(webServerMode ? "ON" : "OFF");
      
      // Enter web server mode - Create Access Point
      Serial.println("Starting Access Point...");
      
      // Handle WiFi interference - disconnect from internet WiFi if connected
      handleWiFiInterference();
      
      // Configure WiFi with dual mode (AP + STA) to avoid conflicts
      WiFi.mode(WIFI_AP_STA);
      WiFi.softAPConfig(localIP, gateway, subnet);
      WiFi.softAP(ap_ssid, ap_password);

      // Mulai DNS server: arahkan semua domain (termasuk cjack.com) ke IP AP 192.168.4.1
      dnsServer.start(DNS_PORT, "*", localIP);
      
      IPAddress IP = WiFi.softAPIP();
      Serial.print("Access Point started! IP: ");
      Serial.println(IP);
      
      // Start web server
      server.on("/", handleRoot);
      server.on("/main", handleMainMenu);
      server.on("/settings", handleSettings);
      server.on("/api/wifi", handleWiFiSettings);
      server.on("/api/cloud", handleCloudSettings);
      server.on("/api/auto-injection", handleAutoInjection);
      server.on("/api/submit-data", sendDataToCloud);
      server.on("/status", handleGetStatus);
      server.on("/set_amplitude", handleSetAmplitude);
      server.begin();
      Serial.println("Web server started");
      
      displayWebServerMode();
      switchHandled = true;
    }
    // Handle switch release (HIGH state)
    else if (currentSwitchState == HIGH && webServerMode) {
      Serial.println("Switch released! Deactivating web server mode...");
      webServerMode = false;
      Serial.print("Web server mode: ");
      Serial.println(webServerMode ? "ON" : "OFF");
      
      // Exit web server mode
      Serial.println("Stopping web server...");
      server.stop();
      dnsServer.stop();
      WiFi.softAPdisconnect(true);
      Serial.println("Web server stopped");
      
      // Redraw normal interface
      drawFrame();
      updateValues(voltage, currentA, resistanceVal);
      updateTime();
      updateStatus();
      switchHandled = true;
    }
  }
  
  lastSwitchState = currentSwitchState;
}

void handleWebServer() {
  if (webServerMode) {
    dnsServer.processNextRequest();
    server.handleClient();
  }
}
